name: Test → Percy → Deploy

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

env:
  PERCY_TOKEN: ${{ secrets.PERCY_TOKEN }}
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  CLOUDFLARE_ACCOUNT_ID: dd01b432f0329f87bb1cc1a3fad590ee

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Build
        run: npm run build

      # ── STEP 1: Run Playwright tests against production ──────────────────
      - name: Run Playwright tests
        id: playwright
        run: |
          npx playwright test --reporter=json > test-results.json 2>&1 || true
          TOTAL=$(python3 -c "import json; d=json.load(open('test-results.json')); print(d.get('stats',{}).get('expected',0)+d.get('stats',{}).get('unexpected',0))" 2>/dev/null || echo 0)
          PASSED=$(python3 -c "import json; d=json.load(open('test-results.json')); print(d.get('stats',{}).get('expected',0))" 2>/dev/null || echo 0)
          if [ "$TOTAL" -gt 0 ]; then
            RATE=$(python3 -c "print(int($PASSED/$TOTAL*100))")
          else
            RATE=0
          fi
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "rate=$RATE" >> $GITHUB_OUTPUT
          echo "Tests: $PASSED/$TOTAL ($RATE%)"
          if [ "$RATE" -lt 85 ]; then
            echo "❌ Pass rate $RATE% below threshold 85% — blocking deploy"
            exit 1
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-results
          path: |
            test-results.json
            test-results/

      # ── STEP 2: Deploy to Cloudflare Pages ───────────────────────────────
      - name: Deploy to Cloudflare Pages
        if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
        run: |
          npx wrangler pages deploy dist \
            --project-name=mission-control-cole \
            --branch=production \
            --commit-dirty=true
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ env.CLOUDFLARE_ACCOUNT_ID }}

      # ── STEP 3: Percy Visual Regression ──────────────────────────────────
      - name: Percy snapshot
        if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
        run: |
          sleep 30  # Wait for CF Pages to propagate
          npx percy exec -- node -e "
            const { chromium } = require('playwright');
            const percySnapshot = require('@percy/playwright');
            (async () => {
              const browser = await chromium.launch();
              const page = await browser.newPage({ viewport: { width: 1440, height: 900 } });
              await page.goto('https://mission-control-cole.pages.dev', { waitUntil: 'networkidle', timeout: 30000 });
              await page.waitForTimeout(3000);
              await percySnapshot(page, 'Mission Control - Post Deploy');
              await browser.close();
            })();
          "

      # ── STEP 4: 3-Platform Screenshots ───────────────────────────────────
      - name: Take 3-platform screenshots
        if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
        run: |
          mkdir -p screenshots
          node -e "
            const { chromium, devices } = require('playwright');
            (async () => {
              const browser = await chromium.launch();
              const URL = 'https://mission-control-cole.pages.dev';

              for (const [name, ctx] of [
                ['desktop', { viewport: { width: 1440, height: 900 } }],
                ['iphone', devices['iPhone 14 Pro']],
                ['android', devices['Pixel 7']],
              ]) {
                const context = await browser.newContext(ctx);
                const page = await context.newPage();
                await page.goto(URL, { waitUntil: 'networkidle', timeout: 30000 });
                await page.waitForTimeout(2000);
                await page.screenshot({ path: 'screenshots/' + name + '.png' });
                await context.close();
                console.log('✅ ' + name);
              }
              await browser.close();
            })();
          "

      - name: Upload screenshots
        if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: deploy-screenshots-${{ github.sha }}
          path: screenshots/

      - name: Summary
        if: always()
        run: |
          echo "## Deploy Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Tests:** ${{ steps.playwright.outputs.passed }}/${{ steps.playwright.outputs.total }} (${{ steps.playwright.outputs.rate }}%)" >> $GITHUB_STEP_SUMMARY
          echo "- **URL:** https://mission-control-cole.pages.dev" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
